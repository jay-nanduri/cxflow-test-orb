description: >
  Command is used to retrieve the latest Checkmarx scan results and publish results in in Json format or using a desired
  bug tracker supported by CxFlow
parameters:
  checkmarx-url:
    type: string
    default: "${CHECKMARX_URL}"
    description: "Provide Checkmarx URL"
  team:
    type: string
    default: "\\CxServer\\SP\\Company"
    description: "Select a Checkmarx Team"
  version:
    type: string
    default: "8.9"
    description: "Select a Checkmarx version"
  auth-scopes:
    type: string
    default: "sast_rest_api"
    description: "Checkmarx Access Control Scopes"
  project:
    type: string
    default: "${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BRANCH}"
    description: "Select a Checkmarx Project"
  app:
    type: string
    default: "${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BRANCH}"
    description: "Select an Application Name used by downstream bug tracker systems"
  apply-filters:
    type: string
    default: "--filter-severity=High --filter-severity=Medium --filter-severity=Low"
    description: "Select report filter criteria"
  bug-tracker:
    type: string
    default: "Json"
    description: "Select a proper bug tracker"
  break:
    type: boolean
    default: false
    description: "Break build based on Checkmarx findings?"
  params:
    type: string
    default: ""
    description: "Additional CLI parameters"
  report-folder:
    type: string
    default: "./"
    description: "Folder to save report"
  report-file:
    type: string
    default: "cx.json"
    description: "Report filename"
  scanners:
    type: string
    default: "sast"
    description: "Vulnerabiility scanners"
  sca-appUrl:
    type: string
    default: ''
    description: 'SCA Scan APP URL'
  sca-apiUrl:
    type: string
    default: ''
    description: 'SCA Scan API URL'
  sca-username:
    type: string
    default: ''
    description: 'SCA Username'
  sca-password:
    type: string
    default: ''
    description: 'SCA Password'
  sca-tenant:
    type: string
    default: ''
    description: 'SCA Tenant'

steps:
  - run:
      name: Checkmarx Results
      command: |
        java -jar /app/cx-flow.jar \
        --project \
        --cx-team="<< parameters.team >>" \
        --cx-project="<< parameters.project >>" \
        --app="<< parameters.app >>" \
        --spring.profiles.active="<< parameters.scanners >>" \
        --cx-flow.enabled-vulnerability-scanners="<< parameters.scanners >>" \
        --cx-flow.bug-tracker="<< parameters.bug-tracker >>" \
        --cx-flow.bug-tracker-impl="<< parameters.bug-tracker >>" \
        << parameters.apply-filters >> \
        --checkmarx.version=<< parameters.version >> \
        --checkmarx.scope="<< parameters.auth-scopes >>" \
        --checkmarx.url="<< parameters.checkmarx-url >>/cxrestapi" \
        --checkmarx.portal-url="<< parameters.checkmarx-url >>/cxwebinterface/Portal/CxWebService.asmx" \
        --sca.appUrl="<< parameters.sca-appUrl >>" \
        --sca.apiUrl="<< parameters.sca-apiUrl >>" \
        --sca.tenant="<< parameters.sca-tenant >>" \
        --sca.username="<< parameters.sca-username >>" \
        --sca.password="<< parameters.sca-password >>" \
        --json.file-name-format="<< parameters.report-file >>" \
        --json.data-folder="<< parameters.report-folder >>" \
        << parameters.params >>
